name: Build and Release Bloom Fallbacks

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (draft/prerelease/release)'
        required: false
        default: 'draft'
        type: choice
        options:
          - draft
          - prerelease
          - release
  push:
    tags:
      - 'bloom-v*'

permissions:
  contents: write
  id-token: write

jobs:
  build-bloom-assets:
    name: Generate Bloom Fallback Assets
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      digests: ${{ steps.hash.outputs.digests }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          # Install system dependencies for canvas
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
      
      - name: Generate Bloom fallback assets
        run: npm run generate:bloom
      
      - name: Set version from tag or default
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/bloom-v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/bloom-v}
          else
            VERSION="1.0.0-dev.$(date +%Y%m%d%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Create release package
        run: |
          mkdir -p release-package
          cp -r dist/bloom-fallbacks release-package/
          cp BLOOM_ASSETS_LICENSE.md release-package/LICENSE.md
          cp LICENSE release-package/SOFTWARE_LICENSE.txt
          
          # Create README for the release
          cat > release-package/README.md << 'EOF'
          # Bloom Fallback Assets
          
          **Version:** ${{ steps.version.outputs.version }}  
          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Project:** Decrypt The Girl  
          **Copyright:** Â© 2024 A.C. Van Cura
          
          ## Contents
          
          This package contains optimized fallback image assets for the Day Zero Scroll component.
          
          ### Assets Included
          
          - `bloom-fallbacks/bloom-fallback-mobile.jpg` - Mobile device fallback (800x600px)
          - `bloom-fallbacks/bloom-fallback-tablet.jpg` - Tablet device fallback (1200x900px)
          - `bloom-fallbacks/bloom-fallback-desktop.jpg` - Desktop device fallback (1600x1200px)
          - `bloom-fallbacks/manifest.json` - Asset metadata and generation info
          
          ### Features
          
          - **Autosize Encoding**: Each asset is automatically encoded to stay within 50KB for mobile optimization
          - **Responsive Design**: Three sizes optimized for different device categories
          - **Quality-Optimized**: JPEG encoding with automatic quality adjustment
          - **Mobile-First**: Designed for fast loading on mobile networks
          
          ## Usage
          
          These assets can be used as fallback images for the Day Zero Scroll component when live feeds are unavailable.
          
          ## Licensing
          
          - **Assets**: See `LICENSE.md` for asset licensing terms
          - **Software**: The generation software is MIT licensed (see `SOFTWARE_LICENSE.txt`)
          
          ## Attribution
          
          When using these assets, please include:
          
          ```
          Bloom Fallback Assets from "Decrypt The Girl"
          Copyright Â© 2024 A.C. Van Cura
          https://theavcfiles.github.io/Decrypt-The-Girl/
          ```
          
          ## Contact
          
          - **Website**: https://theavcfiles.github.io/Decrypt-The-Girl/
          - **Instagram**: [@DeCrypt_The_Girl](https://instagram.com/DeCrypt_The_Girl)
          - **GitHub**: [TheAVCFiles](https://github.com/TheAVCfiles)
          
          ---
          
          Generated by the Decrypt The Girl build pipeline.
          EOF
          
          # Create archive
          cd release-package
          tar -czf ../bloom-fallbacks-${{ steps.version.outputs.version }}.tar.gz .
          zip -r ../bloom-fallbacks-${{ steps.version.outputs.version }}.zip .
          cd ..
      
      - name: Generate checksums
        id: hash
        run: |
          cd release-package/bloom-fallbacks
          sha256sum *.jpg manifest.json > checksums.txt
          cd ../..
          
          # Generate subjects for SLSA provenance
          files=$(find release-package/bloom-fallbacks -type f -name "*.jpg" -o -name "manifest.json")
          echo "digests=$(sha256sum $files | base64 -w0)" >> "${GITHUB_OUTPUT}"
          
          # Copy checksums to release
          cp release-package/bloom-fallbacks/checksums.txt bloom-checksums.txt
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bloom-fallbacks-${{ steps.version.outputs.version }}
          path: |
            bloom-fallbacks-${{ steps.version.outputs.version }}.tar.gz
            bloom-fallbacks-${{ steps.version.outputs.version }}.zip
            bloom-checksums.txt
            release-package/
          retention-days: 90
  
  create-release:
    name: Create GitHub Release
    needs: build-bloom-assets
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/bloom-v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: bloom-fallbacks-${{ needs.build-bloom-assets.outputs.version }}
          path: ./artifacts
      
      - name: Determine release type
        id: release_type
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          elif [[ "${{ github.ref }}" == *"-beta"* ]] || [[ "${{ github.ref }}" == *"-rc"* ]]; then
            RELEASE_TYPE="prerelease"
          else
            RELEASE_TYPE="release"
          fi
          echo "type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          
          IS_DRAFT="false"
          IS_PRERELEASE="false"
          
          if [[ "$RELEASE_TYPE" == "draft" ]]; then
            IS_DRAFT="true"
          elif [[ "$RELEASE_TYPE" == "prerelease" ]]; then
            IS_PRERELEASE="true"
          fi
          
          echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
      
      - name: Create Release Notes
        run: |
          VERSION="${{ needs.build-bloom-assets.outputs.version }}"
          
          cat > release-notes.md << 'EOF'
          # Bloom Fallback Assets Release
          
          **Version:** ${VERSION}
          **Release Date:** $(date -u +"%Y-%m-%d")
          
          ## ðŸ“¦ What's Included
          
          This release contains optimized Bloom fallback image assets for the **Decrypt The Girl** project's Day Zero Scroll component.
          
          ### Assets
          
          - ðŸ–¼ï¸ **Mobile Fallback** (800x600px) - Optimized for mobile devices
          - ðŸ–¼ï¸ **Tablet Fallback** (1200x900px) - Optimized for tablets
          - ðŸ–¼ï¸ **Desktop Fallback** (1600x1200px) - Optimized for desktop displays
          - ðŸ“‹ **Manifest File** - Metadata and generation information
          - ðŸ” **Checksums** - SHA-256 checksums for verification
          
          ### Key Features
          
          âœ¨ **Autosize Encoding**: Automatic quality adjustment to stay within 50KB file size limits  
          ðŸ“± **Mobile-Optimized**: Designed for fast loading on mobile networks  
          ðŸŽ¨ **Bloom Effects**: Ethereal visual effects with gradient compositions  
          ðŸ”’ **IP Protected**: Assets are licensed under proprietary terms (see LICENSE.md)  
          
          ## ðŸ“¥ Download Options
          
          - **TAR.GZ Archive**: `bloom-fallbacks-${VERSION}.tar.gz`
          - **ZIP Archive**: `bloom-fallbacks-${VERSION}.zip`
          - **Checksums**: `bloom-checksums.txt`
          
          ## ðŸ” Verification
          
          Verify your downloads using the provided checksums:
          
          ```bash
          sha256sum -c bloom-checksums.txt
          ```
          
          ## ðŸ“„ Licensing
          
          - **Assets**: Proprietary license with attribution required (see BLOOM_ASSETS_LICENSE.md)
          - **Software**: MIT License (generation scripts)
          
          ### Attribution Required
          
          When using these assets, include:
          
          ```
          Bloom Fallback Assets from "Decrypt The Girl"
          Copyright Â© 2024 A.C. Van Cura
          https://theavcfiles.github.io/Decrypt-The-Girl/
          ```
          
          ## ðŸ”— Links
          
          - **Project Homepage**: https://theavcfiles.github.io/Decrypt-The-Girl/
          - **Repository**: https://github.com/TheAVCfiles/Decrypt-The-Girl
          - **Documentation**: See README.md in the release package
          - **Commercial Licensing**: [Ko-fi](https://ko-fi.com/decryptthegirl/commissions)
          
          ## ðŸ“ž Support
          
          - **Issues**: [GitHub Issues](https://github.com/TheAVCfiles/Decrypt-The-Girl/issues)
          - **Instagram**: [@DeCrypt_The_Girl](https://instagram.com/DeCrypt_The_Girl)
          
          ---
          
          **Copyright Â© 2024 A.C. Van Cura. All rights reserved.**
          EOF
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Bloom Fallbacks v${{ needs.build-bloom-assets.outputs.version }}
          tag_name: bloom-v${{ needs.build-bloom-assets.outputs.version }}
          body_path: release-notes.md
          draft: ${{ steps.release_type.outputs.is_draft }}
          prerelease: ${{ steps.release_type.outputs.is_prerelease }}
          files: |
            artifacts/bloom-fallbacks-${{ needs.build-bloom-assets.outputs.version }}.tar.gz
            artifacts/bloom-fallbacks-${{ needs.build-bloom-assets.outputs.version }}.zip
            artifacts/bloom-checksums.txt
            BLOOM_ASSETS_LICENSE.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  provenance:
    name: Generate SLSA Provenance
    needs: [build-bloom-assets]
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/bloom-v')
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.4.0
    with:
      base64-subjects: "${{ needs.build-bloom-assets.outputs.digests }}"
      upload-assets: true
      provenance-name: bloom-fallbacks-${{ needs.build-bloom-assets.outputs.version }}.intoto.jsonl
